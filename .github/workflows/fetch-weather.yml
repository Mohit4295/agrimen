name: Fetch Weather Data (Every 5 Minutes)

on:
  schedule:
    # Every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Manual trigger button

jobs:
  fetch-weather:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Fetch All Weather Data
        run: |
          mkdir -p data
          
          echo "ğŸŒ¤ï¸ Fetching OpenWeatherMap..."
          
          # OpenWeatherMap - Current Weather
          curl -s "https://api.openweathermap.org/data/2.5/weather?lat=28.6692&lon=77.4380&units=metric&appid=${{ secrets.OPENWEATHER_API_KEY }}" > data/ow_weather.json
          
          # OpenWeatherMap - Air Pollution
          curl -s "https://api.openweathermap.org/data/2.5/air_pollution?lat=28.6692&lon=77.4380&appid=${{ secrets.OPENWEATHER_API_KEY }}" > data/ow_air.json
          
          # OpenWeatherMap - 5 Day Forecast
          curl -s "https://api.openweathermap.org/data/2.5/forecast?lat=28.6692&lon=77.4380&units=metric&appid=${{ secrets.OPENWEATHER_API_KEY }}" > data/ow_forecast.json
          
          echo "ğŸŒ¦ï¸ Fetching Tomorrow.io..."
          
          # Tomorrow.io - Current Weather
          curl -s "https://api.tomorrow.io/v4/weather/realtime?location=28.6692,77.4380&apikey=${{ secrets.TOMORROW_API_KEY }}&units=metric" > data/tm_weather.json || echo '{"error":"failed"}' > data/tm_weather.json
          
          echo "âœ… All data fetched!"
      
      - name: Create Combined JSON
        run: |
          TIMESTAMP=$(date +%s)
          DATETIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DATETIME_IST=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %H:%M:%S IST")
          
          # Read all files
          OW_WEATHER=$(cat data/ow_weather.json)
          OW_AIR=$(cat data/ow_air.json)
          OW_FORECAST=$(cat data/ow_forecast.json)
          TM_WEATHER=$(cat data/tm_weather.json)
          
          # Create combined JSON
          cat > data/weather.json << EOF
          {
            "lastUpdated": "$DATETIME",
            "lastUpdatedIST": "$DATETIME_IST",
            "timestamp": $TIMESTAMP,
            "refreshInterval": "5 minutes",
            "source": "GitHub Actions",
            "openweather": $OW_WEATHER,
            "airPollution": $OW_AIR,
            "forecast": $OW_FORECAST,
            "tomorrow": $TM_WEATHER
          }
          EOF
          
          echo "ğŸ“¦ Combined weather.json created at $DATETIME_IST"
      
      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/
          git diff --staged --quiet || git commit -m "ğŸŒ¤ï¸ Weather update: $(TZ='Asia/Kolkata' date +'%H:%M IST')"
          git push
